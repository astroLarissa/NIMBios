---
title: "Two-Host with Sinusoidal Forcing of Birth"
authors: DN, TW, LW 
output: html_notebook
---
#Questions to Explore for Monday 19.06.2017



```{r}
#call required packages
#note: won't nessisarily need/use EpiDynamics
#EpiDynamics: https://rdrr.io/github/oswaldosantos/EpiDynamics/
library(EpiModel)
library(EpiDynamics)
library(tergm)
library(deSolve)
require(knitr)
```

##Bifurcation Analysis Plotting
##TO DO: Figure out the storage of data/plot generated by running models--better in R?
##TO DO: Call subfuctions for different approaches to modeling seasonal forcings--figure out in R? MatLab easier


#Trail of EpiDynamics Package for Single Host
```{r}
#library(EpiDynamics)
SIRSinusoidalBirth <- function(pars = NULL, init = NULL, time = NULL, ...) {
  if (is.null(pars)) {
    stop("undefined 'pars'")
  }
  if (is.null(pars)) {
    stop("undefined 'inits'")
  }
  if (is.null(pars)) {
    stop("undefined 'time'")
  }
  
  function1 <- function(pars = NULL, init = NULL, time = NULL) {
    function2 <- function(time, init, pars) {
      with(as.list(c(init, pars)), {
        dS = alpha0 * (1 + alpha1 * sin(w * time)) - beta * S * I - mu * S
        dI = beta * S * I - gamma * I - mu * I
        dR = gamma * I - mu * R
        list(c(dS, dI, dR))
      })
    }
    init <- c(init['S'], init['I'], init['R'])
    output <- ode(times = time, 
                  func = function2, 
                  y = init, parms = pars, ...)
    return(output)
  }
  
  if (length(pars$alpha1) == 1){
    output <- function1(pars = pars, init = init, time = time)    
    return(list(model = function1,
                pars = pars,
                init = init,
                time = time,
                results = as.data.frame(output)))
  }
  
  else{
    if (max(time) < 3650){
      time <- c(0:3650)
    }
    
    alpha2 <- pars$alpha1
    alpha1.range <- length(pars$alpha1)
    bifur.infectious <- matrix(0,nrow=alpha1.range,ncol=10)
    
    for (i in 1:alpha1.range){      
      pars['alpha1'] <- alpha2[i]
      solve.result <- SIRSinusoidalBirth(pars = pars, init = init, time = time)
      init <- c(S = as.numeric(tail(solve.result$results, 1)[2]),
                I = as.numeric(tail(solve.result$results, 1)[3]), 
                R = as.numeric(tail(solve.result$results, 1)[4]))
      for (j in 0:9){
        bifur.infectious[i,j+1] <-
          solve.result$results[((max(time) - j * 365) - 1), 'I']
      }      
    }  
    
    return(data.frame(alpha1 = alpha2, bifur.infectious))
  }
  
}
parameters <- list(beta = 17 / 13, alpha0 = 1 / (50 * 365),
                   alpha1 = 0.25, w = 2 * pi / 365 ,
                   mu = 1 / (50 * 365), gamma =  1 / 13)

parameters2 <- list(beta = 17 / 13, alpha0 = 1 / (50 * 365),
                   alpha1 = seq(0, 0.99, 0.01), w = 2 * pi / 365 ,
                   mu = 1 / (50 * 365), gamma =  1 / 13)

initials <- c(S = 1 / 17, I = 1e-4, R =  1 - (1 / 17 + 1e-4))

# Solve and plot with parameters.
sir.sinusoidal.birth <- SIRSinusoidalBirth(pars = parameters,
                                           init = initials, 
                                           time = 0:(50 * 365))
PlotMods(sir.sinusoidal.birth)

#^^^^Endemic state with Parameters


# Solve and plot with parameters2

sir.sinusoidal.birth <- SIRSinusoidalBirth(pars = parameters2,
                                           init = initials, 
                                           time = 0:(50 * 365))
PlotMods(sir.sinusoidal.birth)

```







Question 1:

Assume: 
sinusoidal (pulsed) birthrate in a stable population over a year. 
alpha0=omega
mortality cost

Consider:
how to treat alpha(t)
  See Peel et al, Keeling & Rohani p 184
herd immunity for different population sizes

```{r}
#TwoHostBaseCode Modified with 
#alpha(t)=alpha0(1+amp.seas*cos(2*pi*t))
#where alpha0=omega

SIRTwo <- function(t, t0, parms) {                          #custom model
  with(as.list(c(t0, parms)), {
    
    dS <- alp*(1+seas.amp*cos(2*pi*t))*(s.num+i.num+r.num) -bet*s.num*i.num - bet.g21*s.num*i2.num - omeg*s.num
    dI <- bet*s.num*i.num-gam*i.num  + bet.g21*s.num*i2.num - omeg_star *i.num - omeg*i.num
    dR <- gam*i.num - omeg* r.num
    
    dS2 <- -bet.g2*s2.num*i2.num - bet.g12*s2.num*i.num + alp.g2 *(s2.num+i2.num+r2.num) - omeg.g2 *s2.num
    dI2 <- bet.g2*s2.num*i2.num-gam.g2*i2.num + bet.g12*s2.num*i.num - omeg.g2*i2.num - omeg_star.g2 *i2.num
    dR2 <- gam.g2*i2.num - omeg.g2 * r2.num
    #anything with a g2 subscript referes to population 2    

    list(c(dS, dI, dR, dS2, dI2, dR2))
    #list(c(dS, dI, dR, dS2, dI2, dR2), prop.infected = i.num/(s.num+i.num+r.num))
  })
}

#beta transmission coefficients, gamma recovery, alpha birth, omega death
#at equilibrium in the absence of pathogen
param <- param.dcm(bet = 5e-7, bet.g2 = 5e-7, 
                   bet.g21= 1e-8, bet.g12 = 1e-8, 
                   gam = 1e-2, gam.g2 = 1e-2,
                   omeg = 1e-6, omeg.g2 = 1e-6, 
                   omeg_star = 1e-8, omeg_star.g2 = 1e-8,
                   alp = 1e-6, seas.amp= 1, alp.g2 = 1e-6)
                   #balance = "g1") #balance av. contact rate between g1 and g2)?
init <- init.dcm(s.num = 1e6, i.num = 1, r.num = 0,
                 s2.num = 1e6, i2.num = 1, r2.num =0)
control <- control.dcm(nsteps = 365, dt = 1, new.mod = SIRTwo)

mod <- dcm(param, init, control)
head(as.data.frame(mod)[,1:3])

par(mfrow = c(1, 1))

plot(mod, y = c("s.num","s2.num","i.num","i2.num","r.num","r2.num"), main = "Two Host Dynamics", legend = "full")
#plot(mod, y = c("s.num","i.num","r.num","prop.infected"), main = "beta 1 senstivity analysis", legend = "full")
#plot(mod, y = c("s.num","i.num","r.num"), main = "SIR numbers", legend = "full")

```

Question 2: How does amplitude of birth rate affect disease dynamics?
Assume: 
all assumption from question 1
```{r}
SIRTwoHostSineBirth <- function(t, t0, parms) {                          #custom model
  with(as.list(c(t0, parms)), {
    
    dS <- alp*(1+seas.amp*sin(2*pi/365*t))*(s.num+i.num+r.num) -bet*s.num*i.num - bet.g21*s.num*i2.num - omeg*s.num
    dI <- bet*s.num*i.num-gam*i.num  + bet.g21*s.num*i2.num - omeg_star *i.num - omeg*i.num
    dR <- gam*i.num - omeg* r.num
    
    dS2 <- -bet.g2*s2.num*i2.num - bet.g12*s2.num*i.num + alp.g2 *(s2.num+i2.num+r2.num) - omeg.g2 *s2.num
    dI2 <- bet.g2*s2.num*i2.num-gam.g2*i2.num + bet.g12*s2.num*i.num - omeg.g2*i2.num - omeg_star.g2 *i2.num
    dR2 <- gam.g2*i2.num - omeg.g2 * r2.num
    #anything with a g2 subscript referes to population 2    
    
    list(c(dS, dI, dR, dS2, dI2, dR2),
         prop.infected = i.num/(s.num+i.num+r.num), 
         prop.infected2 = i2.num/(s2.num+i2.num+r2.num))
  })
}
#beta transmission coefficients, gamma recovery, alpha birth, omega death
#at equilibrium in the absence of pathogen
param <- param.dcm(bet = 5e-7, bet.g2 = 5e-7, 
                   bet.g21= 1e-8, bet.g12 = 1e-8, 
                   gam = 1e-2, gam.g2 = 1e-2,
                   omeg = 1e-6, omeg.g2 = 1e-6, 
                   omeg_star = 1e-8, omeg_star.g2 = 1e-8,
                   alp = 1e-2, seas.amp = 1, alp.g2 = 1e-2)
#balance = "g1") #balance av. contact rate between g1 and g2)?
init <- init.dcm(s.num = 1e6, i.num = 1, r.num = 0,
                 s2.num = 1e6, i2.num = 1, r2.num =0)
control <- control.dcm(nsteps = 365, dt = .25, new.mod = SIRTwoHostSineBirth)

mod2 <- dcm(param, init, control)
#data2 <- as.data.frame(mod2)

par(mfrow = c(1, 1))
plot(mod2, y = c("s.num","s2.num","i.num","i2.num","r.num","r2.num"), main = "Two Host Dynamics - sinusoidal birth\n seasonal forcing = 1", legend = "full")
plot(mod2, y = c("s.num","i.num","r.num","prop.infected"), main = "host 1 SIR", legend = "full")
plot(mod2, y = c("prop.infected","prop.infected2"), main = "Prevalence\nsinusoidal alpha1, cst alpha 2", legend = "full")
# appears that prevalence of host 1 may be oscillating, need to check w/ longer run time

#plot(mod, y = c("s.num","i.num","r.num"), main = "SIR numbers", legend = "full")

### examine prevalence of diseaese in group 1 for longer time scale
###
control.long <- control.dcm(nsteps = 700, dt = 0.25, new.mod = SIRTwoHostSineBirth)
mod2.0 <- dcm(param, init, control.long)
tail(as.data.frame(mod2.0)) #all NaNs

# when does it become all NaNs?
data2.0 <- as.data.frame(mod2.0) # becomes NaNs after t = 408 (step 1629)

data2.0[1625:1629,] #inspect behavior preceding NaNs

# at t = 407.00, i.num = 2.7e7; at t = 407.00, i.num = -1.3e6
# by t = 408.00, only s.num and s2.num are NOT negative numbers

plot(mod2.0, y = c("s.num","s2.num","i.num","i2.num","r.num","r2.num"), main = "Two Host Dynamics - sinusoidal birth\n seasonal forcing = 1\nlong term behavior", legend = "full", xlim = c(0,365))

### something is wrong, system behavior from 0 < t < 365 should not have changed from prior results
### need to follow up on this so we can look at longer term behavior
### i think it is an R problem, not a modelling issue


### Sensitivity analysis: how does amplitude affect pathogen dynamics in each host?
amplitude.seas = seq(from = 0, to = 1, by = 0.2)

sensitive.param <- param.dcm(bet = 5e-7, bet.g2 = 5e-7, 
                   bet.g21= 1e-8, bet.g12 = 1e-8, 
                   gam = 1e-2, gam.g2 = 1e-2,
                   omeg = 1e-6, omeg.g2 = 1e-6, 
                   omeg_star = 1e-8, omeg_star.g2 = 1e-8,
                   alp = 1e-2, seas.amp = amplitude.seas, alp.g2 = 1e-2)
mod2.1 <- dcm(sensitive.param, init, control)
data2.1 <- as.data.frame(mod2.1)

# Host 1: varying seasonal forcing, runs 1:6 (run 1 is no forcing, 6 is max)
# total numbers of infecteds wrt time
plot(mod2.1, y = "i.num", main = "Host 1 - sinusoidal birth\nseasonal forcing: 0, 0.2, 0.4, 0.6, 0.8, 1.0")
   # all runs have 'hump' at beginning
   # run 1 (no forcing) increases monotonically
   # runs 2:6 exhibit fluctuations, run 6 is most extreme

plot(mod2.1, y = "i2.num", main = "Host 2 - constant birth") 
   # all runs are the same. 
   # why is there a 'hump' at the beginning of both plots?

# prevalence [0,1] of disease in ea. host pop.
plot(mod2.1, y = "prop.infected", main = "host 1 prevalence", legend = "full")
   #all runs have same 'peak prevalence'
   #run 1 (no forcing) appears to approach endemic (stable) state
   #other runs fluctuate, run six has most extreme fluctation
   #fluctuations appear to increase in magnitude w/ increase in forcing 

plot(mod2.1, y = "prop.infected2", main = "host 2 prevalence", legend = "full")
   #all 6 runs are identical. No impact from fluctuations in host 1 prevalence
   #Perhaps higher inter-host transmission would change this?

```

Question 3:



Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
